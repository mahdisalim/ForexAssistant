<!DOCTYPE html>
<html lang="en" dir="ltr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chart View - Forex Analysis Assistant</title>
    <link rel="icon" type="image/png" sizes="32x32" href="/static/favicon32.png">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://s3.tradingview.com/tv.js"></script>
    <style>
        body {
            background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%);
            min-height: 100vh;
        }
        .chart-container {
            background: rgba(255, 255, 255, 0.03);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            overflow: hidden;
        }
    </style>
</head>
<body class="text-white">
    <!-- Header -->
    <header class="border-b border-white/10 px-6 py-3">
        <div class="flex items-center justify-between">
            <div class="flex items-center gap-3">
                <a href="/" class="flex items-center gap-2 hover:opacity-80 transition">
                    <i data-lucide="arrow-left" class="w-5 h-5"></i>
                    <span class="text-sm">Back to Dashboard</span>
                </a>
            </div>
            <div class="flex items-center gap-4">
                <h1 id="page-title" class="text-xl font-bold"></h1>
                <span id="chart-info" class="text-sm text-gray-400"></span>
            </div>
            <div class="flex items-center gap-2">
                <button onclick="toggleFullscreen()" class="px-3 py-2 bg-slate-700 hover:bg-slate-600 rounded-lg text-sm transition flex items-center gap-2">
                    <i data-lucide="maximize-2" class="w-4 h-4"></i>
                    <span>Fullscreen</span>
                </button>
            </div>
        </div>
    </header>

    <!-- Charts Container -->
    <main id="charts-container" class="p-4">
        <!-- Charts will be dynamically inserted here -->
    </main>

    <script>
        lucide.createIcons();

        // Parse URL parameters
        const urlParams = new URLSearchParams(window.location.search);
        const symbol = urlParams.get('symbol') || 'EURUSD';
        const mode = urlParams.get('mode') || 'single';
        const timeframes = (urlParams.get('timeframes') || 'H1').split(',');
        const style = urlParams.get('style') || 'day';

        // TradingView symbol mapping
        const symbolMap = {
            'EURUSD': 'FX:EURUSD',
            'GBPUSD': 'FX:GBPUSD',
            'USDJPY': 'FX:USDJPY',
            'USDCHF': 'FX:USDCHF',
            'AUDUSD': 'FX:AUDUSD',
            'USDCAD': 'FX:USDCAD',
            'NZDUSD': 'FX:NZDUSD',
            'EURGBP': 'FX:EURGBP',
            'EURJPY': 'FX:EURJPY',
            'GBPJPY': 'FX:GBPJPY',
            'EURCHF': 'FX:EURCHF',
            'AUDJPY': 'FX:AUDJPY',
            'XAU': 'TVC:GOLD',
            'XAUUSD': 'TVC:GOLD',
            'XAG': 'TVC:SILVER',
            'XAGUSD': 'TVC:SILVER',
            'OIL': 'TVC:USOIL',
            'BTC': 'BINANCE:BTCUSDT',
            'BTCUSD': 'BINANCE:BTCUSDT',
            'ETH': 'BINANCE:ETHUSDT',
            'ETHUSD': 'BINANCE:ETHUSDT',
            'SPX': 'FOREXCOM:SPXUSD',
            'DJI': 'FOREXCOM:DJI',
            'NDX': 'FOREXCOM:NSXUSD'
        };

        // Timeframe mapping for TradingView
        const tfMap = {
            'M1': '1',
            'M5': '5',
            'M15': '15',
            'M30': '30',
            'H1': '60',
            'H4': '240',
            'D1': 'D',
            'W1': 'W',
            'MN1': 'M'
        };

        // Update page title
        document.getElementById('page-title').textContent = symbol;
        document.getElementById('chart-info').textContent = `${mode === 'mtf' ? 'Multi Timeframe' : 'Single Timeframe'} | ${timeframes.join(', ')} | ${style}`;

        // Get TradingView symbol
        function getTVSymbol(sym) {
            return symbolMap[sym.toUpperCase()] || `FX:${sym.toUpperCase()}`;
        }

        // Create chart widget
        function createChart(containerId, tf, height) {
            const tvSymbol = getTVSymbol(symbol);
            const interval = tfMap[tf] || '60';

            new TradingView.widget({
                "autosize": true,
                "symbol": tvSymbol,
                "interval": interval,
                "timezone": "Etc/UTC",
                "theme": "dark",
                "style": "1",
                "locale": "en",
                "toolbar_bg": "#1e293b",
                "enable_publishing": false,
                "hide_side_toolbar": false,
                "allow_symbol_change": true,
                "container_id": containerId,
                "hide_volume": false,
                "studies": [
                    "RSI@tv-basicstudies",
                    "MASimple@tv-basicstudies"
                ]
            });
        }

        // Initialize charts
        function initCharts() {
            const container = document.getElementById('charts-container');
            
            if (mode === 'single' || timeframes.length === 1) {
                // Single chart - full width
                container.innerHTML = `
                    <div class="chart-container" style="height: calc(100vh - 100px);">
                        <div id="chart-0" style="height: 100%;"></div>
                    </div>
                `;
                createChart('chart-0', timeframes[0], 'calc(100vh - 100px)');
            } else {
                // Multi timeframe - grid layout
                const numCharts = timeframes.length;
                let gridClass = 'grid-cols-1';
                let chartHeight = 'calc(50vh - 60px)';
                
                if (numCharts === 2) {
                    gridClass = 'grid-cols-2';
                    chartHeight = 'calc(100vh - 100px)';
                } else if (numCharts === 3) {
                    gridClass = 'grid-cols-3';
                    chartHeight = 'calc(100vh - 100px)';
                } else if (numCharts === 4) {
                    gridClass = 'grid-cols-2';
                    chartHeight = 'calc(50vh - 60px)';
                } else if (numCharts > 4) {
                    gridClass = 'grid-cols-3';
                    chartHeight = 'calc(50vh - 60px)';
                }

                let chartsHTML = `<div class="grid ${gridClass} gap-4">`;
                timeframes.forEach((tf, index) => {
                    chartsHTML += `
                        <div class="chart-container" style="height: ${chartHeight};">
                            <div class="px-3 py-2 bg-slate-800/50 border-b border-white/10 flex items-center justify-between">
                                <span class="text-sm font-medium">${symbol} - ${tf}</span>
                                <span class="text-xs text-gray-400">Timeframe: ${tf}</span>
                            </div>
                            <div id="chart-${index}" style="height: calc(100% - 40px);"></div>
                        </div>
                    `;
                });
                chartsHTML += '</div>';
                container.innerHTML = chartsHTML;

                // Create each chart
                timeframes.forEach((tf, index) => {
                    setTimeout(() => {
                        createChart(`chart-${index}`, tf, chartHeight);
                    }, index * 200);
                });
            }
        }

        // Toggle fullscreen
        function toggleFullscreen() {
            if (!document.fullscreenElement) {
                document.documentElement.requestFullscreen();
            } else {
                document.exitFullscreen();
            }
        }

        // Initialize on load
        document.addEventListener('DOMContentLoaded', initCharts);
    </script>
</body>
</html>
